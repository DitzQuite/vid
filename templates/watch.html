{% extends "base.html" %}
{% block content %}
<div class="player card">
  <h2>{{ video.title }}</h2>

  <div class="video-wrapper">
    <video id="player" preload="metadata" class="video-el">
      <source src="/api/videos/{{ video.id }}/stream" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <div class="controls">
      <button id="playPause" class="btn small">▶</button>
      <input type="range" id="seek" value="0" min="0" max="100" step="0.1">
      <span id="time">0:00</span>
    </div>
  </div>

  {% if not ispublic %}<span class="badge">UNDER REVIEW</span><br>{% endif %}
  <span class="creator">
    <img src="{{owner.avatar_path}}" class="avatar">
    <a class="nos" href="/profile/{{owner.id}}">{{ owner.username }}</a> {% if owner.role == 'Administrator' %}<span class="badge">STAFF</span>{% endif %}
    <div class="actions">
      <button id="likeBtn" class="btn">Like ({{ video.likes_count }})</button>
      {% if user and user.id != video.owner_id %}
        <button id="watchBtn" class="btn">Watch</button>
      {% endif %}
    </div>
  </span>
  <p>{{ video.description }}</p>
</div>

<section class="card comments">
  <h3>Comments</h3>
  {% if user %}
    <form id="commentForm" class="comment-form">
      <textarea name="text" required></textarea>
      <button class="btn" type="submit">Post</button>
    </form>
  {% else %}
    <p><a href="/login">Login</a> to comment.</p>
  {% endif %}

  <div id="commentList">
    {% for c in comments %}
      <div class="comment">
        <strong>{{ c.username }}</strong> <span class="muted">{{ c.timestamp }}</span>
        <p>{{ c.text }}</p>
      </div>
    {% endfor %}
  </div>
</section>

<style>
.video-wrapper {
  position: relative;
  width: 100%;
  background: #000;
  border-radius: 8px;
  overflow: hidden;
}
.video-el {
  width: 100%;
  height: auto;
  display: block;
}
.video-el::-webkit-media-controls {
  display: none !important;
}
.controls {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px;
  background: rgba(0,0,0,0.5);
  position: absolute;
  bottom: 0;
  width: 100%;
}
.controls .btn.small {
  padding: 4px 8px;
  font-size: 14px;
}
#seek {
  flex: 1;
}
#time {
  color: #fff;
  font-size: 12px;
}
</style>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('player');
    const playBtn = document.getElementById('playPause');
    const seek = document.getElementById('seek');
    const time = document.getElementById('time');

    playBtn.addEventListener('click', () => {
      if (video.paused) {
        video.play();
        playBtn.textContent = '❚❚';
      } else {
        video.pause();
        playBtn.textContent = '▶';
      }
    });

    video.addEventListener('timeupdate', () => {
      if (!isNaN(video.duration)) {
        seek.value = (video.currentTime / video.duration) * 100;
        const m = Math.floor(video.currentTime / 60);
        const s = Math.floor(video.currentTime % 60).toString().padStart(2, '0');
        time.textContent = `${m}:${s}`;
      }
    });

    seek.addEventListener('input', () => {
      video.currentTime = (seek.value / 100) * video.duration;
    });

    const videoId = "{{ video.id }}";
    const likeBtn = document.getElementById('likeBtn');

    likeBtn?.addEventListener('click', async () => {
      const token = getCookie('access_token');
      if (!token) return;

      likeBtn.textContent = `Processing`;

      const res = await fetch(`/api/videos/${videoId}/like`, {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token }
      });

      if (res.ok) {
        const likeRes = await fetch(`/api/videos/${videoId}/likes`);
        if (likeRes.ok) {
          const data = await likeRes.json();
          likeBtn.textContent = `Like (${data.likes})`;
        }
      } else {
        console.error('Failed to like video');
      }
    });

    document.getElementById('commentForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = e.target.elements['text'].value;
      const fd = new FormData();
      fd.append('text', text);
      await fetch('/api/videos/' + videoId + '/comment', { 
        method: 'POST', 
        headers: { Authorization: 'Bearer ' + getCookie('access_token') }, 
        body: fd 
      });
      location.reload();
    });

    const watchBtn = document.getElementById('watchBtn');
    watchBtn?.addEventListener('click', async () => {
      await fetch('/api/users/{{ video.owner_id }}/watch', { 
        method: 'POST', 
        headers: { Authorization: 'Bearer ' + getCookie('access_token') }
      });
      location.reload();
    });
  });
</script>
{% endblock %}
